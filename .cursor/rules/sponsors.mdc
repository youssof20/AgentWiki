---
description: Rules for integrating hackathon sponsor APIs. Apply when working with ElevenLabs, ClickHouse, Supabase, Langfuse, or AWS.
globs: "*elevenlabs*,*supabase*,*aws*,*clickhouse*,*langfuse*,integrations/*.py"
alwaysApply: false
---

# SPONSOR APIS ‚Äî USE THESE FOR BONUS JUDGE POINTS
**Use for Agentwiki:** ClickHouse (DB), ElevenLabs (voice), Langfuse (LLM tracing), Supabase (fallback DB), AWS (storage ‚Äî given). Only use env vars necessary for project goals (see core ENV list).

**Env vars (from .env for project goals):** GROQ/OPENROUTER/MISTRAL/GEMINI, ELEVENLABS, CLICKHOUSE_*, SUPABASE_*, LANGFUSE_*, AWS_*, GITHUB/REPO/REPO_URL.

# ELEVENLABS ‚Äî VOICE OUTPUT
```python
from elevenlabs.client import ElevenLabs
import tempfile, os

def speak_text(text: str) -> bytes | None:
    """Convert text to speech using ElevenLabs. Returns audio bytes or None on failure."""
    try:
        client = ElevenLabs(api_key=os.getenv("ELEVENLABS_API_KEY"))
        audio = client.text_to_speech.convert(
            voice_id="21m00Tcm4TlvDq8ikWAM",  # Rachel - default voice
            text=text[:500],  # Cap at 500 chars to save free credits
            model_id="eleven_multilingual_v2"
        )
        return b"".join(audio)
    except Exception:
        return None  # Fail silently ‚Äî don't crash the demo
```
In app.py: if audio := speak_text(output): st.audio(audio, format="audio/mp3")
Show badge: st.caption("üé§ Powered by ElevenLabs")

# CLICKHOUSE ‚Äî PREFERRED DATABASE (Method Cards + metrics)
Use ClickHouse as the primary store when CLICKHOUSE_* env vars are set. Store Method Cards and/or agent metrics; support search/retrieve (e.g. by task_intent, tags). Fallback to Supabase or local JSON if ClickHouse is unavailable.
```python
import clickhouse_connect, os

def get_clickhouse():
    """Get ClickHouse client. Returns None if unavailable."""
    try:
        return clickhouse_connect.get_client(
            host=os.getenv("CLICKHOUSE_HOST"),
            username=os.getenv("CLICKHOUSE_USER"),
            password=os.getenv("CLICKHOUSE_PASSWORD"),
        )
    except Exception:
        return None

def save_method_card_to_clickhouse(card: dict) -> bool:
    """Insert Method Card. Returns True on success."""
    try:
        client = get_clickhouse()
        if not client:
            return False
        client.insert("method_cards", [[
            card.get("id"), card.get("timestamp"), card.get("task_intent"),
            card.get("context"), card.get("plan"), str(card.get("tool_calls", "")),
            card.get("mistakes"), card.get("fixes"), card.get("outcome_score"),
            ",".join(card.get("tags", [])),
        ]], column_names=[
            "id", "timestamp", "task_intent", "context", "plan", "tool_calls",
            "mistakes", "fixes", "outcome_score", "tags",
        ])
        return True
    except Exception:
        return False
```
Create table (ClickHouse SQL): `CREATE TABLE method_cards (id String, timestamp DateTime64(3), task_intent String, context String, plan String, tool_calls String, mistakes String, fixes String, outcome_score Float64, tags String) ENGINE = MergeTree() ORDER BY (timestamp, id);`
For metrics only: use agent_metrics (generation, rating, response_time_ms) as in the metrics block below. Show badge: st.caption("üìä Powered by ClickHouse")

# CLICKHOUSE ‚Äî METRICS LOGGING (when used as DB or for analytics)
```python
import clickhouse_connect, os

def log_metric(generation: int, rating: float, response_time_ms: int):
    """Log performance metric to ClickHouse for the improvement chart."""
    try:
        client = clickhouse_connect.get_client(
            host=os.getenv("CLICKHOUSE_HOST"),
            username=os.getenv("CLICKHOUSE_USER"),
            password=os.getenv("CLICKHOUSE_PASSWORD")
        )
        client.insert("agent_metrics",
            [[generation, rating, response_time_ms]],
            column_names=["generation", "rating", "response_time_ms"]
        )
    except Exception:
        pass  # Non-critical ‚Äî don't crash if ClickHouse is unavailable
```
Show badge: st.caption("üìä Analytics by ClickHouse")

# LANGFUSE ‚Äî LLM OBSERVABILITY / TRACING (use for Agentwiki)
Use Langfuse to trace LLM calls (prompts, responses, latency, tokens). Demo must not crash if keys are missing ‚Äî check get_langfuse() before tracing.
```python
from langfuse import Langfuse
import os

def get_langfuse():
    """Return Langfuse client or None if not configured."""
    if not os.getenv("LANGFUSE_PUBLIC_KEY"):
        return None
    try:
        return Langfuse(
            public_key=os.getenv("LANGFUSE_PUBLIC_KEY"),
            secret_key=os.getenv("LANGFUSE_SECRET_KEY"),
            host=os.getenv("LANGFUSE_HOST", "https://cloud.langfuse.com"),
        )
    except Exception:
        return None
# Wrap LLM calls: trace = get_langfuse(); if trace: trace.generation(...) or use decorator/callback.
```
Show badge when used: st.caption("üìà Traced with Langfuse")

# SUPABASE ‚Äî FALLBACK CLOUD MEMORY (when ClickHouse unavailable)
```python
from supabase import create_client
import os

def get_supabase():
    """Initialize Supabase client."""
    return create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_ANON_KEY"))

def save_to_supabase(data: dict) -> bool:
    """Save memory/Method Card to Supabase. Returns True on success. Use when ClickHouse unavailable."""
    try:
        get_supabase().table("agent_memory").insert(data).execute()
        return True
    except Exception:
        return False  # Fall back to local JSON

def load_from_supabase(quality: str = "good", limit: int = 5) -> list:
    """Load best memory entries from Supabase."""
    try:
        result = get_supabase().table("agent_memory")\
            .select("*")\
            .eq("quality_label", quality)\
            .order("created_at", desc=True)\
            .limit(limit)\
            .execute()
        return result.data
    except Exception:
        return []
```
SQL to create the table (paste in Supabase SQL editor): CREATE TABLE agent_memory (id bigserial PRIMARY KEY, created_at timestamptz DEFAULT now(), user_input text, agent_output text, rating integer CHECK (rating BETWEEN 1 AND 5), quality_label text, generation integer DEFAULT 1, system_prompt_used text);

# AWS ‚Äî STORAGE (given ‚Äî use for backup / storage)
```python
import boto3, os, json

def save_to_s3(data: dict, filename: str = "memory.json"):
    """Save memory/Method Cards backup to AWS S3."""
    try:
        kwargs = dict(
            aws_access_key_id=os.getenv("AWS_ACCESS_KEY_ID"),
            aws_secret_access_key=os.getenv("AWS_SECRET_ACCESS_KEY"),
            region_name=os.getenv("AWS_DEFAULT_REGION") or os.getenv("AWS_REGION", "me-south-1"),
        )
        if os.getenv("AWS_SESSION_TOKEN"):
            kwargs["aws_session_token"] = os.getenv("AWS_SESSION_TOKEN")
        s3 = boto3.client("s3", **kwargs)
        s3.put_object(
            Bucket=os.getenv("AWS_BUCKET_NAME"),
            Key=filename,
            Body=json.dumps(data)
        )
        return True
    except Exception:
        return False
```
Show badge: st.caption("‚òÅÔ∏è Backed up on AWS")

# SPONSOR PRIORITY FOR TIME
1. **ClickHouse** ‚Äî DB for Method Cards + metrics.
2. **ElevenLabs** ‚Äî voice (most visible).
3. **Langfuse** ‚Äî LLM tracing (use it).
4. **Supabase** ‚Äî fallback DB if ClickHouse unavailable.
5. **AWS** ‚Äî storage/backup (given ‚Äî use it).
